{"createdAt":"2025-09-14T18:46:28.144Z","updatedAt":"2025-09-29T18:59:20.934Z","id":"IdvP7STGDx9LzELt","name":"4.1 - Disparo Whatsapp","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"d2046b40-56a8-4290-b9bf-f04e2bc122a2","name":"Schedule Trigger"},{"parameters":{"operation":"getAll","tableId":"leads","returnAll":true,"filters":{"conditions":[{"keyName":"id_disparo","condition":"eq","keyValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[416,0],"id":"2db247b1-baa2-40c5-8e19-84bf3a75061c","name":"Pega Leads do Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"operation":"getAll","tableId":"disparos","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"data_hora","condition":"lte","keyValue":"={{$json[\"timestamp\"]}}"},{"keyName":"status","condition":"eq","keyValue":"Em andamento"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[208,0],"id":"51ef4c92-0c18-41eb-b97d-dce8483a5c3b","name":"Pega Disparos Agendados","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"assignments":{"assignments":[{"id":"59ff38c0-5bb5-41fb-9e42-bc90aa134824","name":"mensagem","value":"={{ $('Pega Disparos Agendados').item.json.mensagem }}","type":"string"},{"id":"662fdd3a-8574-496b-bcc2-a65311f1ec9b","name":"imagem","value":"={{ $('Pega Disparos Agendados').item.json.imagem_url }}","type":"string"},{"id":"5a1ad5b9-c0f3-4215-a17f-d4832dace959","name":"remetente","value":"","type":"string"},{"id":"d5de298f-2320-448c-a83e-d23b3298260c","name":"nome","value":"={{ $json.nome }}","type":"string"},{"id":"7bc1856e-87c7-485d-9a8b-b411e46cc501","name":"telefone","value":"={{ $json.telefone }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,0],"id":"7a7c2bb6-9d70-49ce-9678-1d438a5b46f5","name":"Edit Fields"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1104,0],"id":"fff959d0-dcec-4b6c-8b2d-30363bffa526","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1344,16],"id":"efeb6f65-e455-4233-ad75-5846f744285e","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"finamob-avatar-murilo","remoteJid":"={{ $json.telefone }}","media":"={{ $json.base64 }}","caption":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1840,240],"id":"2bfc630f-692d-44b0-81ad-9d74ca871f19","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"TwnJW4TK9NKnvtx3","name":"finamob-avatar-murilo"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Code node — Mode: Run Once for All Items\nfunction normalizeTelefone(raw) {\n  if (raw == null) return \"\";\n  let d = String(raw).replace(/\\D/g, \"\").replace(/^0+/, \"\");\n  return d ? (d.startsWith(\"55\") ? d : \"55\" + d) : \"\";\n}\n\nfunction stripBOM(buf) {\n  return (buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF)\n    ? buf.slice(3)\n    : buf;\n}\n\nfunction fixPngSignature(buf) {\n  // PNG correto: 89 50 4E 47 0D 0A 1A 0A\n  if (buf.length >= 7 &&\n      buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47 && // \"PNG\"\n      buf[3] === 0x0D && buf[4] === 0x0A && buf[5] === 0x1A && buf[6] === 0x0A) {\n    // faltou 0x89 antes de \"PNG\"\n    return Buffer.concat([Buffer.from([0x89]), buf]);\n  }\n  return buf;\n}\n\nasync function getBinaryWithHeaders(url) {\n  try {\n    const res = await this.helpers.httpRequest({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      responseFormat: 'arraybuffer',\n      returnFullResponse: true,\n    });\n    return { buf: Buffer.from(res.data ?? res), mime: res.headers?.['content-type'] || \"\" };\n  } catch {\n    const res = await this.helpers.request({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      json: false,\n      encoding: null,\n      resolveWithFullResponse: true,\n    });\n    return { buf: Buffer.from(res.body), mime: res.headers?.['content-type'] || \"\" };\n  }\n}\n\nreturn await Promise.all(items.map(async (item) => {\n  const mensagem  = item.json?.mensagem;\n  const remetente = item.json?.remetente;\n  const nome      = item.json?.nome;\n  const telefone  = normalizeTelefone(item.json?.telefone);\n  const url       = (item.json?.imagem ?? \"\").toString().trim();\n\n  let base64 = \"\";\n\n  if (url) {\n    try {\n      let { buf, mime } = await getBinaryWithHeaders.call(this, url);\n      buf = Buffer.from(buf);\n      buf = stripBOM(buf);\n      // Se for PNG sem 0x89 no início, corrige\n      const isPngHint = (mime && mime.includes('png')) ||\n                        (buf.length >= 3 && buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47);\n      if (isPngHint && buf.length >= 7) buf = fixPngSignature(buf);\n      base64 = buf.toString('base64');\n    } catch {\n      base64 = \"\";\n    }\n  }\n\n  return {\n    json: { mensagem, remetente, nome, telefone, base64 }\n  };\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[832,0],"id":"e669db20-f29d-4557-8652-e8583860a44c","name":"Code"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d7e64dd7-1f48-4920-86a9-cf7e9d63d4c5","leftValue":"={{ $json.base64 }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1552,16],"id":"2413d3e5-f9af-45ca-ad16-c22c5e4d7c64","name":"If"},{"parameters":{"resource":"messages-api","instanceName":"finamob-avatar-murilo","remoteJid":"={{ $json.telefone }}","messageText":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1840,0],"id":"660034c3-4cb0-4e70-9dc0-94ab3b6726c1","name":"Envio do Resumo1","credentials":{"evolutionApi":{"id":"TwnJW4TK9NKnvtx3","name":"finamob-avatar-murilo"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"update","tableId":"disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Pega Leads do Supabase').item.json.id_disparo }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"Enviado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2272,240],"id":"f72c1cdf-fb99-4055-9d54-6d9baa5414c7","name":"Update a row","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"operation":"get","tableId":"finamob-mensagens","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Variáveis do Fluxo').item.json.message.chat_id }}"},{"keyName":"nome_app","keyValue":"={{ $('Variáveis do Fluxo').item.json.AppName }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2528,240],"id":"0bbaedd7-548b-4a61-826b-45792be735f0","name":"Busca Dados","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Dados').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2736,240],"id":"79d55a53-64ba-4c7d-ac8c-1cb514d37472","name":"Verifica se encontrou"},{"parameters":{"tableId":"finamob-mensagens","fieldsUi":{"fieldValues":[{"fieldId":"telefone","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.chat_id }}"},{"fieldId":"id_conversa","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.message_id }}"},{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"},{"fieldId":"nome_app","fieldValue":"={{ $('Variáveis do Fluxo').item.json.AppName }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,160],"id":"a40abebc-865d-42b8-96c8-f9cfeb39563e","name":"Adiciona Mensagem","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[3264,240],"id":"31dad246-461d-41d6-8e98-35fbfe56525b","name":"Faz o Merge","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"id_usuario","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.chat_id }}"},{"fieldId":"mensagem_usuario","fieldValue":"={{ $('Seta Mensagem para o Agente').item.json.message }}"},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Saida do Agente').item.json.texto }}"},{"fieldId":"telefone","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.chat_id }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Variáveis do Fluxo').item.json.nomeDoLead }}"},{"fieldId":"id_conversa","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.message_id }}"},{"fieldId":"message_type","fieldValue":"={{ $('Variáveis do Fluxo').item.json.message.content_type }}"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"={{ $('Variáveis do Fluxo').item.json.AppName }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3504,240],"id":"8a15fe51-5537-4eba-9bb3-9b8ac89ecf80","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Pega Disparos Agendados","type":"main","index":0}]]},"Pega Disparos Agendados":{"main":[[{"node":"Pega Leads do Supabase","type":"main","index":0}]]},"Pega Leads do Supabase":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"If","type":"main","index":0}]]},"Envio do Resumo":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"If":{"main":[[{"node":"Envio do Resumo1","type":"main","index":0}],[{"node":"Envio do Resumo","type":"main","index":0}]]},"Envio do Resumo1":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Update a row":{"main":[[{"node":"Busca Dados","type":"main","index":0}]]},"Busca Dados":{"main":[[]]},"Verifica se encontrou":{"main":[[{"node":"Adiciona Mensagem","type":"main","index":0}]]},"Adiciona Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":0}]]},"Faz o Merge":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"b59541f5-3f15-467e-9803-e6e02adbaf30","triggerCount":1,"tags":[]}